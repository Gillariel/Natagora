<ui:composition template="/WEB-INF/template/layout.xhtml"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:define name="title">
        Birds Managment
    </ui:define>

    <ui:define name="css">
        <link href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://cdn.datatables.net/buttons/1.4.2/css/buttons.bootstrap.min.css"  rel="stylesheet" type="text/css" />
    </ui:define>

    <ui:define name="content">
        <div class="row">
            <div class="col-sm-12">
                <div class="white-box">
                    <h3 class="box-title m-b-0">Birds</h3>
                    <button type="button" id="newBird" class="pull-right btn btn-info">Create New</button>
                    <p class="text-muted m-b-30">All birds</p>
                    <div class="table-responsive">
                        <h:dataTable id="example" class="table display" value="#{birdsHandler.all()}" var="b">
                            <h:column class="id">    				
                                <f:facet name = "header">Id</f:facet>    				
                                #{b.id}
                            </h:column>

                            <h:column>    				
                                <f:facet name = "header">Name</f:facet>    				
                                #{b.name}
                            </h:column>

                            <h:column>    				
                                <f:facet name = "header">Height</f:facet>    				
                                #{b.length}
                            </h:column>

                            <h:column>    				
                                <f:facet name = "header">Weigth</f:facet>    				
                                #{b.weight}
                            </h:column>
                            <h:column headerClass="sorting_disabled">
                                <f:facet name = "header">Actions</f:facet>
                                <a data-id="#{b.id}" data-name ="#{b.name}" data-length="#{b.length}" data-weight="#{b.weight}" class="edit-btn"><i class="fa fa-pencil-square-o fa-2x"></i> </a>
                                <a data-id="#{b.id}" data-name="#{b.name}" class="delete-btn"><i class="fa fa-trash-o fa-2x"></i> </a>
                            </h:column>
                        </h:dataTable>
                    </div>
                </div>
            </div>
        </div>
    </ui:define>
    <ui:define name="js">

        <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.4.2/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.4.2/js/buttons.bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
        <script src="//cdn.datatables.net/buttons/1.4.2/js/buttons.html5.min.js"></script>
        <script src="//cdn.datatables.net/buttons/1.4.2/js/buttons.print.min.js"></script>
        <script src="//cdn.datatables.net/buttons/1.4.2/js/buttons.colVis.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.0.3/sweetalert2.all.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>
        
        <h:outputScript name="ample/js/datatable.js"/>
        
        <h:outputScript name="ample/js/ajax.js" />
        
        <script>
            $(document).ready(function(){
                setEditClick();
                setDeleteClick();
                
                $('#newBird').on('click', function() {
                    var id, name, length, weight;
                    swal({
                        title: 'Create a new Bird',
                        showCancelButton: true,
                        confirmButtonText: 'Create',
                        html:
                            '<input type="text" id="swal-input1" class="swal2-input" autofocus="true" placeholder="Name of Bird" />' +
                            '<input type="number" id="swal-input2" class="swal2-input pull-left" placeholder="Bird\'s length" />' +
                            '<input type="number" id="swal-input3" class="swal2-input pull-right" placeholder="Bird\'s weight" />',
                        preConfirm: function() {
                            return new Promise(function(resolve) {
                                name = $('#swal-input1').val();
                                length = $('#swal-input2').val();
                                weight = $('#swal-input3').val();
                                var data = {
                                    id: 1,
                                    name: name,
                                    length: parseInt(length),
                                    weight: parseInt(weight),
                                    date: ""
                                };
                                console.log(JSON.stringify(data));
                                $.ajax({
                                    url: "http://192.168.128.13:8081/NataRest/api/birds",
                                    type: 'POST',
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    data: JSON.stringify(data),
                                    headers: {
                                        'api-key': "136519fd-6d11-4a53-94e3-78f74abd56ee"
                                    },
                                    success: function (data) {
                                        id = data.id;
                                        resolve("true");
                                    },
                                    error: function () {
                                        resolve("false");
                                    }
                                });
                            });
                        }
                    }).then(function(resolve) {
                        if(resolve === "true") {
                            line.remove();
                            tbody.append( '<tr role="row">' +
                                '<td>' + id + '</td>' +
                                '<td>' + name + '</td>' +
                                '<td>' + length + '</td>' +
                                '<td>' + weight + '</td>' +
                                '<td><a data-id="' + id + '" data-name ="' + name + '" data-length="' + length + '" data-weight="' + weight + '" class="edit-btn"><i class="fa fa-pencil-square-o fa-2x"></i> </a>' +
                                '<a data-id="' + id + '" data-name="' + name + '" class="delete-btn"><i class="fa fa-trash-o fa-2x"></i> </a></td>' +
                                '</tr>'
                            );
                            setEditClick();
                            swal({
                                type:'success',
                                title:'Bird has been created'
                            });
                        } else if(resolve === "false"){
                            swal({
                                type: 'error',
                                title: 'Server failed to response :('
                            });
                        }
                    });
                });
                
                function setEditClick() {
                    $('.edit-btn').on('click', function() {
                        var name = $(this).data("name");
                        var length = $(this).data('length');
                        var weight = $(this).data('weight');
                        var id = $(this).data("id");
                        var tbody = $(this).parent().parent().parent();
                        var line = $(this).parent().parent();

                        swal({
                            title: 'Edit "' + name + '"',
                            showCancelButton: true,
                            confirmButtonText: 'Update',
                            html:
                                '<input type="text" id="swal-input1" class="swal2-input" autofocus="true" value="' + name +'" />' +
                                '<input type="number" id="swal-input2" class="swal2-input" value="' + length +'" />' +
                                '<input type="number" id="swal-input3" class="swal2-input" value="' + weight +'" />',
                            preConfirm: function() {
                                return new Promise(function(resolve) {
                                    var isOneInputIsChanged = (
                                            name !== $('#swal-input1').val() ||
                                            length !== $('#swal-input2').val() ||
                                            weight !== $('#swal-input3').val()
                                    );
                                    //ajax here to, see delete for example
                                    if (isOneInputIsChanged) {
                                        name = $('#swal-input1').val();
                                        length = $('#swal-input2').val();
                                        weight = $('#swal-input3').val();
                                        var data = {
                                            id: id,
                                            name: name,
                                            length: parseInt(length),
                                            weight: parseInt(weight),
                                            date: ""
                                        };
                                        console.log(JSON.stringify(data));
                                        $.ajax({
                                            url: "http://192.168.128.13:8081/NataRest/api/birds/" + id,
                                            type: 'PUT',
                                            contentType: "application/json; charset=utf-8",
                                            data: JSON.stringify(data),
                                            headers: {
                                                'api-key': "136519fd-6d11-4a53-94e3-78f74abd56ee"
                                            },
                                            success: function () {
                                                resolve("true");
                                            },
                                            error: function () {
                                                resolve("false");
                                            }
                                        });
                                    }
                                });
                            }
                        }).then(function(resolve) {
                            if(resolve === "true") {
                                line.remove();
                                tbody.append( '<tr role="row">' +
                                    '<td>' + id + '</td>' +
                                    '<td>' + name + '</td>' +
                                    '<td>' + length + '</td>' +
                                    '<td>' + weight + '</td>' +
                                    '<td><a data-id="' + id + '" data-name ="' + name + '" data-length="' + length + '" data-weight="' + weight + '" class="edit-btn"><i class="fa fa-pencil-square-o fa-2x"></i> </a>' +
                                    '<a data-id="' + id + '" data-name="' + name + '" class="delete-btn"><i class="fa fa-trash-o fa-2x"></i> </a></td>' +
                                    '</tr>'
                                );
                                setEditClick();
                                swal({
                                    type:'success',
                                    title:'Bird has been updated!'
                                });
                            } else if(resolve === "false") {
                                swal({
                                    type: 'error',
                                    title: 'Server failed to response :('
                                });
                            }
                        });
                    });
                };
                
                function setDeleteClick() {
                    $('.delete-btn').on('click', function() {
                        var id = $(this).data("id");
                        var line = $(this).parent().parent();
                        var name = $(this).data("name");

                        swal({
                            title: 'Are you sure?',
                            text: "Delete cannot be undone!",
                            type: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Delete',
                            confirmButtonColor: '#3085d6',
                            cancelButtonText: 'No!',
                            showLoaderOnConfirm: true,
                            preConfirm: function () {
                                return new Promise(function (resolve) {
                                    //console.log(id);
                                    $.ajax({
                                        url: "http://192.168.128.13:8081/NataRest/api/birds/" + id,
                                        type: 'DELETE',
                                        data: { },
                                        headers: {
                                            'api-key': "136519fd-6d11-4a53-94e3-78f74abd56ee"
                                        },
                                        success: function() {
                                            console.log("OnSuccess");
                                            resolve("true");
                                        },
                                        error: function(data, error){
                                            console.log(error);
                                            resolve("false");
                                        }
                                    });
                                });
                            },
                            allowOutsideClick: false
                        }).then(function (resolve) {
                            if (resolve === "true") {
                                swal({
                                    type: 'success',
                                    title: name + ' has correctly been deleted!'
                                }).then(function(){
                                    line.remove();
                                });  
                            }else if(resolve === "false"){
                                swal({
                                    type: 'error',
                                    title: 'Server failed to response :('
                                });
                            }
                        });
                    });
                };
                
            });
        </script>
        
    </ui:define>
</ui:composition>

